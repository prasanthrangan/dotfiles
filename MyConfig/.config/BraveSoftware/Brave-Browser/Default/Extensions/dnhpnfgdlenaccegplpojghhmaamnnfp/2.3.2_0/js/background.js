(()=>{"use strict";class e{static has(e){return Object.prototype.hasOwnProperty.call(this.cache,e)}static get(e){return void 0!==this.cache[e]||void 0===this.defaults?this.cache[e]:(void 0===this.defaults[e]&&console.warn('Unrecognized storage key "%s"',e),this.defaults[e])}static set(e,t){return this.cache[e]=t,this._adapter.set({[e]:t})}static import(e){for(const[t,s]of Object.entries(e))this.cache[t]=s;return this._adapter.set(e)}static remove(e){return void 0!==this.cache[e]&&delete this.cache[e],this._adapter.remove(e)}static keys(e=""){return Object.keys(this.cache).filter((t=>t.startsWith(e)))}static entries(){return Object.entries(this.cache)}static async clear(e=!1){let t;e||(t=(this.persistent??[]).reduce(((e,t)=>(e[t]=this.cache[t],e)),{})),await this._adapter.clear(),this.cache={},e||await this.import(t)}static async init(){const t=this._adapter===browser.storage.sync?"sync":"local",s=e.caches[t];return void 0!==s?(this.cache=s,this.cache):(e.caches[t]={},this.cache=e.caches[t],browser.storage.onChanged.addListener(((e,s)=>{if(t===s)for(const[t,{newValue:s}]of Object.entries(e))this.cache[t]=s})),Object.assign(this.cache,await this._adapter.get(null)))}static then(e,t){const s=this._initialized?Promise.resolve(this.cache):this.init();return this._initialized=!0,s.then(e,t)}static toJson(){return JSON.stringify(this.cache)}}e.caches={};const t={version:browser.runtime.getManifest().version,db_version:3};class s extends e{}s._adapter=browser.storage.sync||browser.storage.local,s.QUOTA_BYTES_PER_ITEM=browser.storage.sync?8192:5240832,s.defaults=Object.freeze({language:"english",version:t.version,version_show:!0,highlight_owned_color:"#00ce67",highlight_wishlist_color:"#0491bf",highlight_coupon_color:"#a26426",highlight_inv_gift_color:"#800040",highlight_inv_guestpass_color:"#513c73",highlight_notinterested_color:"#4f4f4f",highlight_collection_color:"#856d0e",highlight_waitlist_color:"#4c7521",tag_owned_color:"#00b75b",tag_wishlist_color:"#0383b4",tag_coupon_color:"#c27120",tag_inv_gift_color:"#b10059",tag_inv_guestpass_color:"#65449a",tag_notinterested_color:"#4f4f4f",tag_collection_color:"#856d0e",tag_waitlist_color:"#4c7521",highlight_owned:!0,highlight_wishlist:!0,highlight_coupon:!1,highlight_inv_gift:!1,highlight_inv_guestpass:!1,highlight_notinterested:!1,highlight_excludef2p:!1,highlight_collection:!0,highlight_waitlist:!0,tag_owned:!1,tag_wishlist:!1,tag_coupon:!1,tag_inv_gift:!1,tag_inv_guestpass:!1,tag_notinterested:!0,tag_collection:!1,tag_waitlist:!1,tag_short:!1,hidetmsymbols:!1,showlowestprice:!0,showlowestprice_onwishlist:!0,showlowestpricecoupon:!0,showallstores:!0,stores:[],override_price:"auto",showregionalprice:"mouse",regional_countries:["us","gb","ru","br","au","jp"],show_es_homepagetabs:!0,showmarkettotal:!1,showsteamrepapi:!0,showmcus:!0,showoc:!0,showhltb:!0,showyoutube:!0,showtwitch:!0,showpcgw:!0,showcompletionistme:!1,showprotondb:!1,showviewinlibrary:!1,showsteamcardexchange:!1,showitadlinks:!0,showsteamdb:!0,showbartervg:!1,showastatslink:!0,showyoutubegameplay:!0,showyoutubereviews:!0,showwsgf:!0,exfgls:!0,app_custom_link:[{enabled:!1,name:"Google",url:"google.com/search?q=[ID]+[NAME]",icon:"www.google.com/images/branding/product/ico/googleg_lodp.ico"}],customize_apppage:{recentupdates:!0,reviews:!0,about:!0,contentwarning:!0,steamchart:!0,steamspy:!0,surveys:!0,sysreq:!0,legal:!0,morelikethis:!0,recommendedbycurators:!0,customerreviews:!0},customize_frontpage:{featuredrecommended:!0,specialoffers:!0,trendingamongfriends:!0,discoveryqueue:!0,browsesteam:!0,curators:!0,morecuratorrecommendations:!0,recentlyupdated:!0,fromdevelopersandpublishersthatyouknow:!0,popularvrgames:!0,homepagetabs:!0,gamesstreamingnow:!0,under:!0,updatesandoffers:!0,homepagesidebar:!0},show_package_info:!1,show_steamchart_info:!0,show_steamspy_info:!0,show_early_access:!0,show_alternative_linux_icon:!1,show_itad_button:!1,skip_got_steam:!1,installsteam:"show",openinnewtab:!1,keepssachecked:!1,showemptywishlist:!0,user_notes_app:!0,user_notes_wishlist:!0,showwishliststats:!0,oneclickremovewl:!1,user_notes:{},user_notes_adapter:"synced_storage",replaceaccountname:!0,showlanguagewarning:!0,showlanguagewarninglanguage:"english",homepage_tab_selection:"remember",homepage_tab_last:null,send_age_info:!0,removebroadcasts:!1,mp4video:!1,horizontalscrolling:!0,showsupportinfo:!0,showdrm:!0,regional_hideworld:!1,showinvnav:!0,quickinv:!0,quickinv_diff:-.01,community_default_tab:"",showallachievements:!1,showallstats:!0,replacecommunityhublinks:!1,hideannouncementcomments:!1,showachinstore:!0,hideactivelistings:!1,showlowestmarketprice:!0,hidespamcomments:!1,spamcommentregex:"[\\u2500-\\u25FF]",wlbuttoncommunityapp:!0,removeguideslanguagefilter:!1,disablelinkfilter:!1,sortfriendsby:"default_ASC",sortreviewsby:"default_ASC",sortgroupsby:"default_ASC",show1clickgoo:!0,show_profile_link_images:"gray",show_custom_themes:!0,profile_pinned_bg:!1,profile_steamrepcn:!0,profile_steamgifts:!0,profile_steamtrades:!0,profile_bartervg:!0,profile_steamrep:!0,profile_steamdbcalc:!0,profile_astats:!0,profile_backpacktf:!0,profile_astatsnl:!0,profile_steamid:!0,profile_custom_link:[{enabled:!0,name:"Google",url:"google.com/search?q=[ID]",icon:"www.google.com/images/branding/product/ico/googleg_lodp.ico"}],fav_emoticons:[],group_steamgifts:!0,steamcardexchange:!0,purchase_dates:!0,show_badge_progress:!0,show_coupon:!0,show_wishlist_link:!0,show_wishlist_count:!0,show_progressbar:!0,show_backtotop:!1,profile_showcase_twitch:!0,profile_showcase_own_twitch:!1,profile_showcase_twitch_profileonly:!1,itad_import_library:!1,itad_import_wishlist:!1,add_to_waitlist:!1,context_steam_store:!1,context_steam_market:!1,context_itad:!1,context_bartervg:!1,context_steamdb:!1,context_steamdb_instant:!1,context_steam_keys:!1}),s.persistent=["user_notes","user_notes_adapter"];let r=!1;class a extends Error{constructor(e){super(e),this.name="LoginError"}}class n extends Error{constructor(e){super(e),this.name="ServerOutageError"}}class o extends Error{constructor(e,t){super(t),this.code=e}}class i extends Error{constructor(e,t){super(e),this.featureName=t}}const c={LoginError:a,ServerOutageError:n,HTTPError:o,FeatureDependencyError:i};class l{static get(e,t){const s=e.trim();return l.cache.has(s)?l.cache.get(s):t}static set(e,t,s=31536e3){let r=e.trim(),a=t.trim();l.cache.set(r,a),r=encodeURIComponent(r),a=encodeURIComponent(a),document.cookie=`${r}=${a}; max-age=${s}`}static remove(e){let t=e.trim();l.cache.delete(t),t=encodeURIComponent(t),document.cookie=`${t}; expires=Thu, 01 Jan 1970 00:00:00 GMT`}static init(){l.cache=new Map;for(let[e,t]of document.cookie.split(";").map((e=>e.split("="))))e=e.trim(),l.cache.set(e,decodeURIComponent(t))}}l.init();const u=Object.freeze({BACKGROUND:1,CONTENT_SCRIPT:2,OPTIONS:3});let p;if(browser.extension.getBackgroundPage){const e=browser.extension.getBackgroundPage();p=e===window?u.BACKGROUND:u.OPTIONS}else p=u.CONTENT_SCRIPT;class d{static isBackgroundScript(){return p===u.BACKGROUND}static isContentScript(){return p===u.CONTENT_SCRIPT}static isOptions(){return p===u.OPTIONS}}class m{static getCurrentSteamLanguage(){if(null!==this._currentSteamLanguage)return this._currentSteamLanguage;for(const e of document.querySelectorAll("script[src]")){const t=new URL(e.src).searchParams.get("l");if(t)return m._currentSteamLanguage=t,this._currentSteamLanguage}return d.isContentScript()&&(m._currentSteamLanguage=l.get("Steam_Language")||null),this._currentSteamLanguage}static getLanguageCode(e){return m.languages[e]||"en"}static isCurrentLanguageOneOf(e){return e.includes(m.getCurrentSteamLanguage())}}m._currentSteamLanguage=null,m.languages={english:"en",bulgarian:"bg",czech:"cs",danish:"da",dutch:"nl",finnish:"fi",french:"fr",greek:"el",german:"de",hungarian:"hu",italian:"it",japanese:"ja",koreana:"ko",norwegian:"no",polish:"pl",portuguese:"pt-PT",brazilian:"pt-BR",russian:"ru",romanian:"ro",schinese:"zh-CN",spanish:"es-ES",latam:"es-419",swedish:"sv-SE",tchinese:"zh-TW",thai:"th",turkish:"tr",ukrainian:"ua",vietnamese:"vi"};class h{static getURL(e){return browser.runtime.getURL(e)}static get(e){return fetch(h.getURL(e))}static getJSON(e){return h.get(e).then((e=>e.json()))}static getText(e){return h.get(e).then((e=>e.text()))}}class g{static loadLocalization(e){return h.getJSON(`/localization/${e}.json`)}static init(){if(g._promise)return g._promise;let e=m.getCurrentSteamLanguage();const t=s.get("language");function r(e,t){for(const[s,a]of Object.entries(t))void 0!==e[s]?"object"==typeof a?r(e[s],a):""!==a&&(e[s]=a):console.warn("The key %s doesn't exist in the English localization file",s);return e}null===e?e=t:e!==t&&(s.set("language",e),class{static message(e){return browser.runtime.sendMessage(e)}static action(e,...t){return t.length?this.message({action:e,params:t}):this.message({action:e})}}.action("clearpurchases"));const a=m.getLanguageCode(e),n=["en"];return null!==a&&"en"!==a&&n.push(a),g._promise=Promise.all(n.map((e=>g.loadLocalization(e)))).then((([e,t])=>(g.str=e,t&&r(g.str,t),g.str))),g._promise}static then(e,t){return g.init().then(e,t)}static getString(e){const t=e.split(".").reverse();let s=g.str;for(;t.length;){if("object"!=typeof s)return null;s=s[t.pop()]}return s}}g._promise=null;class w extends e{static async init(){return await super.init(),this===w?this.migrate():null}static async migrate(){const e=this.get("local_storage_migration");let t;if("store.steampowered.com"===location.hostname)t="store";else if("steamcommunity.com"===location.hostname)t="community";else{if(d.isContentScript())return null;t="extension"}return e[t]?null:(await Promise.all(Object.keys(w.defaults).map((async e=>{let t=localStorage.getItem(e);if(null!==t){try{t=JSON.parse(t)}catch(e){throw console.error("Can't parse value",t),e}await w.set(e,t),localStorage.removeItem(e)}}))),e[t]=!0,w.set("local_storage_migration",e))}}w._adapter=browser.storage.local,w.defaults=Object.freeze({access_token:null,lastItadImport:{from:null,to:null},login:{steamId:null,profilePath:null},storeCountry:null,expand_slider:!1,es_guide_tags:{},market_stats:{startListing:null,purchaseTotal:0,saleTotal:0},popular_refresh:!1,workshop_state:"",playback_hd:!1,show_review_section:!0,steampeek:!1,support_info:null,hide_login_warn_store:!1,hide_login_warn_community:!1,review_filters:{},local_storage_migration:{store:!1,community:!1,extension:!1}});const f=["contextMenus"],y=Object.freeze({context_steam_store:{persistent:!0,permissions:f},context_steam_market:{persistent:!0,permissions:f},context_itad:{persistent:!0,permissions:f},context_bartervg:{persistent:!0,permissions:f},context_steamdb:{persistent:!0,permissions:f},context_steamdb_instant:{persistent:!0,permissions:f},context_steam_keys:{persistent:!0,permissions:f}});class _{static contains(e){return browser.permissions.contains({permissions:e})}static request(e){return browser.permissions.request({permissions:e})}static remove(e){return e.includes("contextMenus")&&browser.contextMenus.removeAll(),browser.permissions.remove({permissions:e})}static async when(e,t,s){t&&(await _.contains([e])&&t(),browser.permissions.onAdded.addListener((s=>{s.permissions.includes(e)&&t()}))),s&&browser.permissions.onRemoved.addListener((t=>{t.permissions.includes(e)&&s()}))}static requestOption(e){return _.request(y[e].permissions)}static removeOption(e){const t=_._getUnusedPermissions(e);return 0===t.length?Promise.resolve(!0):_.remove(t)}static _getUnusedPermissions(e){const t=new Set;for(const[r,a]of Object.entries(y))if(e!==r&&(!a.persistent||s.get(r)))for(const e of a.permissions)t.add(e);const r=new Set;for(const s of y[e].permissions)t.has(s)||r.add(s);return Array.from(r.values())}}class b{static onClick(e){const t=b.queryLinks[e.menuItemId];if(!t)return;let s=e.selectionText.trim();if("context_steam_keys"===e.menuItemId){const e=s.match(/[A-Z0-9]{5}(-[A-Z0-9]{5}){2}/g);Array.isArray(e)&&(s=e.join(","))}browser.tabs.create({url:t.replace("__query__",encodeURIComponent(s))})}static async build(){await s,await g;for(const e of Object.keys(b.queryLinks))s.get(e)&&browser.contextMenus.create({id:e,title:g.str.options[e].replace("__query__","%s"),contexts:["selection"]},(()=>chrome.runtime.lastError))}static async update(){return await _.contains(["contextMenus"])?(await browser.contextMenus.removeAll(),b.build()):null}}b.queryLinks={context_steam_store:"https://store.steampowered.com/search/?term=__query__",context_steam_market:"https://steamcommunity.com/market/search?q=__query__",context_itad:"https://isthereanydeal.com/search/?q=__query__",context_bartervg:"https://barter.vg/search?q=__query__",context_steamdb:"https://steamdb.info/search/?q=__query__",context_steamdb_instant:"https://steamdb.info/instantsearch/?query=__query__",context_steam_keys:"https://store.steampowered.com/account/registerkey?key=__query__"};class v{constructor(e){this._promise=new Promise((t=>{this._id=setTimeout((()=>{t()}),e)}))}then(e,t){if(this._promise)return this._promise.then(e,t);throw new Error("Timer has been cleared before")}clear(){clearTimeout(this._id),this._promise=null}}class S{constructor(e,t){this.onDone=e,this.duration=t,this.reset()}get running(){return this._running}reset(){void 0!==this._id&&clearTimeout(this._id),this._id=setTimeout((async()=>{await this.onDone(),this._running=!1}),this.duration),this._running=!0}}class k{static timer(e){return new v(e)}static resettableTimer(e,t){return new S(e,t)}static now(){return Math.trunc(Date.now()/1e3)}}let x,A;const E=new WeakMap,I=new WeakMap,O=new WeakMap,P=new WeakMap,C=new WeakMap;let j={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return I.get(e);if("objectStoreNames"===t)return e.objectStoreNames||O.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return T(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function D(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(A||(A=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(F(this),e),T(E.get(this))}:function(...e){return T(t.apply(F(this),e))}:function(e,...s){const r=t.call(F(this),e,...s);return O.set(r,e.sort?e.sort():[e]),T(r)}:(e instanceof IDBTransaction&&function(e){if(I.has(e))return;const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",n),e.removeEventListener("abort",n)},a=()=>{t(),r()},n=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",n),e.addEventListener("abort",n)}));I.set(e,t)}(e),s=e,(x||(x=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>s instanceof e))?new Proxy(e,j):e);var t,s}function T(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",n)},a=()=>{t(T(e.result)),r()},n=()=>{s(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",n)}));return t.then((t=>{t instanceof IDBCursor&&E.set(t,e)})).catch((()=>{})),C.set(t,e),t}(e);if(P.has(e))return P.get(e);const t=D(e);return t!==e&&(P.set(e,t),C.set(t,e)),t}const F=e=>C.get(e),L=["get","getKey","getAll","getAllKeys","count"],R=["put","add","delete","clear"],M=new Map;function q(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(M.get(t))return M.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,a=R.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!a&&!L.includes(s))return;const n=async function(e,...t){const n=this.transaction(e,a?"readwrite":"readonly");let o=n.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),a&&n.done]))[0]};return M.set(t,n),n}var N;N=j,j={...N,get:(e,t,s)=>q(e,t)||N.get(e,t,s),has:(e,t)=>!!q(e,t)||N.has(e,t)};class ${static init(){return $._promise||($._promise=function(e,t,{blocked:s,upgrade:r,blocking:a,terminated:n}={}){const o=indexedDB.open(e,t),i=T(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(T(o.result),e.oldVersion,e.newVersion,T(o.transaction))})),s&&o.addEventListener("blocked",(()=>s())),i.then((e=>{n&&e.addEventListener("close",(()=>n())),a&&e.addEventListener("versionchange",(()=>a()))})).catch((()=>{})),i}("Augmented Steam",t.db_version,{upgrade(e,t,s,r){t<1&&(e.createObjectStore("coupons").createIndex("appid","appids",{unique:!1,multiEntry:!0}),e.createObjectStore("giftsAndPasses").createIndex("appid","",{unique:!1,multiEntry:!0}),e.createObjectStore("items"),e.createObjectStore("earlyAccessAppids"),e.createObjectStore("purchases"),e.createObjectStore("dynamicStore").createIndex("appid","",{unique:!1,multiEntry:!0}),e.createObjectStore("packages").createIndex("expiry","expiry"),e.createObjectStore("storePageData").createIndex("expiry","expiry"),e.createObjectStore("profiles").createIndex("expiry","expiry"),e.createObjectStore("rates"),e.createObjectStore("notes"),e.createObjectStore("collection"),e.createObjectStore("waitlist"),e.createObjectStore("itadImport")),t<2&&(e.createObjectStore("workshopFileSizes").createIndex("expiry","expiry"),e.createObjectStore("reviews").createIndex("expiry","expiry")),t<3&&(e.createObjectStore("expiries").createIndex("expiry",""),r.objectStore("packages").deleteIndex("expiry"),r.objectStore("storePageData").deleteIndex("expiry"),r.objectStore("profiles").deleteIndex("expiry"),r.objectStore("workshopFileSizes").deleteIndex("expiry"),r.objectStore("reviews").deleteIndex("expiry"))},blocked(){console.error("Failed to upgrade database, there is already an open connection")}}).then((e=>{$.db=e})).then($._deleteOldData)),$._promise}static then(e,t){return $.init().then(e,t)}static async _deleteOldData(){const e=$.db.transaction("expiries","readwrite").store;let t=await e.index("expiry").openCursor(IDBKeyRange.upperBound(k.now()));const s=[],r={},a=[];for(;t;)s.push(t.primaryKey),a.push(e.delete(t.primaryKey)),t=await t.continue();for(const e of s){const[t,s]=e.split(/_/);r[t]||(r[t]=[]),s&&r[t].push(s)}for(const[e,t]of Object.entries(r)){const s=$.db.transaction(e,"readwrite").store;$.timestampedStores.has(e)?a.push(s.clear()):a.push(Promise.all(t.map((e=>{const t=s.delete(e),r=Number(e);return r?Promise.all([t,s.delete(r)]):t}))))}return Promise.all(a)}static async put(e,t,{ttl:s,multiple:r="object"==typeof t}={}){const a=$.db.transaction(e,"readwrite");let n;const o=[],i=$.cacheObjectStores.has(e),c=$.timestampedEntriesStores.has(e);function l(t){let s;s=a.store.autoIncrement||null!==a.store.keyPath?a.store.put(t):a.store.put(null,t),s.then((t=>{c&&o.push(`${e}_${t}`)}))}if(i){const t=s||$.cacheObjectStores.get(e);n=k.now()+t,c||o.push(e)}if(r)if(Array.isArray(t))t.forEach(l);else if("object"==typeof t){const s=t instanceof Map?t.entries():Object.entries(t);for(const[t,r]of s)a.store.put(r,t).then((t=>{c&&o.push(`${e}_${t}`)}))}else console.warn("multiple parameter specified but the data is a primitive");else l(t);await a.done;const u=$.db.transaction("expiries","readwrite");for(const e of o)u.store.put(n,e);return u.done}static async get(e,t,s={}){const r=$._asArray(t);await Promise.all([$.checkStoreExpiry(e,s),$.checkEntryExpiry(e,r,s)]);const a=$.db.transaction(e).store,n=await Promise.all(r.map((e=>a.get(e))));return Array.isArray(t)?$._resultsAsObject(r,n):n[0]}static async getAll(e,t={}){const s=[],r=[];let a;for(await $.checkStoreExpiry(e,t),$.timestampedEntriesStores.has(e)&&await $.checkEntryExpiry(e,await $.db.getAllKeys(e),t),a=await $.db.transaction(e).store.openCursor();a;)s.push(a.key),r.push(a.value),a=await a.continue();return $._resultsAsObject(s,await Promise.all(r))}static async getFromIndex(e,t,s,r={}){if($.timestampedEntriesStores.has(e))return null;await $.checkStoreExpiry(e,r);const a=$._asArray(s),n=$.db.transaction(e).store.index(t),o=await Promise.all(a.map((e=>r.asKey?r.all?n.getAllKeys(e):n.getKey(e):r.all?n.getAll(e):n.get(e))));return Array.isArray(s)?$._resultsAsObject(a,o):o[0]}static async indexContainsKey(e,t,s,r={}){if($.timestampedEntriesStores.has(e))return null;await $.checkStoreExpiry(e,r);const a=$._asArray(s),n=$.db.transaction(e).store.index(t),o=await Promise.all(a.map((e=>n.openKeyCursor(e).then((e=>Boolean(e))))));return Array.isArray(s)?$._resultsAsObject(a,o):o[0]}static delete(e,t){const s=$._asArray(t),r=$.db.transaction(e,"readwrite").store;let a;return $.cacheObjectStores.has(e)&&(a=$.db.transaction("expiries","readwrite").store),Promise.all(s.map((t=>{const s=r.delete(t);return a?Promise.all([s,a.delete($.timestampedStores.has(e)?e:`${e}_${t}`)]):s})))}static clear(e=Array.from($.cacheObjectStores.keys())){const t=$._asArray(e);let s;return t.some((e=>$.cacheObjectStores.has(e)))&&(s=$.db.transaction("expiries","readwrite").store),Promise.all(t.map((e=>{const t=$.db.clear(e);if($.cacheObjectStores.has(e)){let r;return r=$.timestampedStores.has(e)?e:IDBKeyRange.bound(`${e}_`,`${e}${String.fromCharCode("_".charCodeAt(0)+1)}`,!1,!0),Promise.all([t,s.delete(r)])}return t})))}static async contains(e,t,s={}){const r=$._asArray(t);await Promise.all([$.checkStoreExpiry(e,s),$.checkEntryExpiry(e,r,s)]);const a=$.db.transaction(e).store,n=await Promise.all(r.map((e=>a.openCursor(e).then((e=>Boolean(e))))));return Array.isArray(t)?$._resultsAsObject(r,n):n[0]}static async checkEntryExpiry(e,t,s={}){if(!$.timestampedEntriesStores.has(e))return null;const r=$.db.transaction("expiries"),a=[];for(const s of t)r.store.get(`${e}_${s}`).then((e=>{e&&!$.isExpired(e)||a.push(s)}));if(await r.done,s.preventFetch){const t=$.db.transaction(e,"readwrite");for(const e of a)t.store.delete(e);return t.done}return Promise.all(a.map((t=>$.fetchUpdatedData(e,t,s.params))))}static async checkStoreExpiry(e,t={}){if(!$.timestampedStores.has(e))return null;const s=await $.db.get("expiries",e);let r=!0;return s&&(r=$.isExpired(s)),r&&(await $.clear(e),!t.preventFetch)?$.fetchUpdatedData(e,null,t.params):null}static fetchUpdatedData(e,t,s){const r=t?`${e}_${t}`:e;if($._ongoingRequests.has(r))return $._ongoingRequests.get(r);let a;const n=$.timestampedStores.has(e);return a=n?$.objStoreFetchFns.get(e)({params:s}):$.objStoreFetchFns.get(e)({params:s,key:t}),a=a.catch((async s=>{throw console.group("Object store data"),t?console.error("Failed to update key %s of object store %s",t,e):console.error("Failed to update object store %s",e),console.error(s),console.groupEnd(),await $.db.put("expiries",k.now()+60,n?e:`${e}_${t}`),s})).finally((()=>$._ongoingRequests.delete(r))),$._ongoingRequests.set(r,a),a}static isExpired(e){return e<=k.now()}static _asArray(e){return Array.isArray(e)?e:[e]}static _resultsAsObject(e,t){return e.reduce(((e,s,r)=>(e[s]=t[r],e)),{})}}$._promise=null,$._ongoingRequests=new Map,$.timestampedStores=new Map([["coupons",3600],["giftsAndPasses",3600],["items",3600],["earlyAccessAppids",3600],["purchases",86400],["dynamicStore",900],["rates",3600],["collection",900],["waitlist",900]]),$.timestampedEntriesStores=new Map([["packages",604800],["storePageData",3600],["profiles",86400],["workshopFileSizes",432e3],["reviews",3600]]),$.cacheObjectStores=new Map([...$.timestampedStores,...$.timestampedEntriesStores]);class z{static parseId(e){if(!e)return null;return parseInt(e)||null}static getAppid(e){let t=e;if(!t)return null;if(t instanceof HTMLElement){const e=t.dataset.dsAppid;if(e)return z.parseId(e);if(t=t.href,!t)return null}const s=t.match(/(?:store\.steampowered|steamcommunity)\.com\/(?:app|games|market\/listings)\/(\d+)\/?/);return s&&z.parseId(s[1])}static getSubid(e){let t=e;if(!t)return null;if(t instanceof HTMLElement){const e=t.dataset.dsPackageid;if(e)return z.parseId(e);if(t=t.href,!t)return null}const s=t.match(/(?:store\.steampowered|steamcommunity)\.com\/sub\/(\d+)\/?/);return s&&z.parseId(s[1])}static getBundleid(e){let t=e;if(!t)return null;if(t instanceof HTMLElement){const e=t.dataset.dsBundleid;if(e)return z.parseId(e);if(t=t.href,!t)return null}const s=t.match(/(?:store\.steampowered|steamcommunity)\.com\/bundle\/(\d+)\/?/);return s&&z.parseId(s[1])}static trimStoreId(e){return Number(e.slice(e.indexOf("/")+1))}static getAppidImgSrc(e){let t=e;if(!t)return null;if(t instanceof HTMLImageElement&&(t=t.hasAttribute("src")?t.getAttribute("src"):t.dataset.imageUrl,!t))return null;const s=t.match(/(?:cdn\.(?:akamai|cloudflare)\.steamstatic\.com\/steam|steamcdn-a\.akamaihd\.net\/steam|steamcommunity\/public\/images)\/apps\/(\d+)\//);return s&&z.parseId(s[1])}static getAppidUriQuery(e){if(!e)return null;const t=e.match(/appid=(\d+)/);return t&&z.parseId(t[1])}static getAppids(e){const t=/(?:store\.steampowered|steamcommunity)\.com\/app\/(\d+)\/?/g,s=[];let r;for(;null!==(r=t.exec(e));){const e=z.parseId(r[1]);e&&s.push(e)}return s}static getAppidFromId(e){if(!e)return null;const t=e.match(/game_(\d+)/);return t&&z.parseId(t[1])}static getAppidFromGameCard(e){if(!e)return null;const t=e.match(/\/gamecards\/(\d+)/);return t&&z.parseId(t[1])}}class W{static escape(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,(e=>t[e]))}static fragment(e){const t=document.createElement("template");return t.innerHTML=DOMPurify.sanitize(e),t.content}static element(e){return W.fragment(e).firstElementChild}static _getNode(e){let t=e;return null==t?(console.warn(`${t} is not an Element.`),null):("string"==typeof t&&(t=document.querySelector(t)),t instanceof Element?t:(console.warn(`${t} is not an Element.`),null))}static inner(e,t){const s=W._getNode(e);return s&&(s.innerHTML=DOMPurify.sanitize(t)),s}static replace(e,t){const s=W._getNode(e);return s&&(s.outerHTML=DOMPurify.sanitize(t)),s}static wrap(e,t,s=t){const r=W._getNode(t);if(!r)return null;const a=null===s?r.parentElement.lastElementChild:W._getNode(s),n=[r];for(let e=r;null!==e.nextElementSibling&&e!==a;e=e.nextElementSibling)n.push(e.nextElementSibling);const o=W.element(e);return r.replaceWith(o),o.append(...n),o}static adjacent(e,t,s){const r=W._getNode(e);return r&&r.insertAdjacentHTML(t,DOMPurify.sanitize(s)),r}static beforeBegin(e,t){W.adjacent(e,"beforebegin",t)}static afterBegin(e,t){W.adjacent(e,"afterbegin",t)}static beforeEnd(e,t){W.adjacent(e,"beforeend",t)}static afterEnd(e,t){W.adjacent(e,"afterend",t)}}class B{static clearSpecialSymbols(e){return e.replace(/[\u00AE\u00A9\u2122]/g,"")}static htmlToDOM(e){return W.fragment(e)}static htmlToElement(e){return W.element(e)}static getVariableFromText(e,t,s){let r;if("object"===s)r=new RegExp(`${t}\\s*=\\s*(\\{.+?\\});`);else if("array"===s)r=new RegExp(`${t}\\s*=\\s*(\\[.+?\\]);`);else if("int"===s)r=new RegExp(`${t}\\s*=\\s*(.+?);`);else{if("string"!==s)return null;r=new RegExp(`${t}\\s*=\\s*(\\".+?\\");`)}const a=e.match(r);return a?"int"===s?parseInt(a[1]):JSON.parse(a[1]):null}static getVariableFromDom(e,t,s=document){for(const r of s.querySelectorAll("script")){const s=B.getVariableFromText(r.textContent,e,t);if(null!==s)return s}return null}}class U{static _fetchWithDefaults(e,t={},s={}){const r=new URL(e,this.origin),a={...this.params,...s};if(a&&"POST"===a.method&&!a.body){const e=new FormData;for(const[s,r]of Object.entries(t))e.append(s,r);a.body=e}else for(const[e,s]of Object.entries(t))r.searchParams.append(e,s);return fetch(r,a)}static async getEndpoint(e,t,s,r={}){let a=e;e.endsWith("/")||(a+="/");const n=await this._fetchWithDefaults(a,t,Object.assign(r,{method:"GET"}));return s&&s(n),n.json()}static async getPage(e,t,s,r={}){const a=await this._fetchWithDefaults(e,t,Object.assign(r,{method:"GET"}));return s&&s(a),a.text()}static async postEndpoint(e,t,s,r={}){let a=e;e.endsWith("/")||(a+="/");const n=await this._fetchWithDefaults(a,t,Object.assign(r,{method:"POST"}));return s&&s(n),n.json()}static async deleteEndpoint(e,t,s,r={}){let a=e;e.endsWith("/")||(a+="/");const n=await this._fetchWithDefaults(a,t,Object.assign(r,{method:"DELETE"}));return s&&s(n),n.json()}static endpointFactory(e,t){return async s=>{let r=await this.getEndpoint(e,s);if(t)if(Array.isArray(t))for(const e of t)r=r[e];else r=r[t];else r=r.data;return r}}static endpointFactoryCached(e,t,s){return async({params:r,key:a}={})=>{let n=await this.getEndpoint(e,r);return n=s?s(n.data):n.data,$.put(t,void 0===a?n:new Map([[a,n]]))}}}U.params={};class K extends w{static isExpired(e,t){let s=t;return!e||(("number"!=typeof t||s<0)&&(s=0),e+s<=k.now())}static get(e){if(void 0===this.ttls[e])return console.warn("No TTL specified for cache storage key",e),this.defaults[e];const t=super.get(e);return!t?.timestamp||this.isExpired(t.timestamp,this.ttls[e])?this.defaults[e]:t.data}static set(e,t){return super.set(e,{data:t,timestamp:k.now()})}static migrate(){localStorage.removeItem("cache_currency")}}K.ttls={currency:3600},K.defaults={currency:null};class G extends U{static cards(e,t){return G.getPage(`/my/gamecards/${e}`,t?{border:1}:{})}static stats(e,t){return G.getPage(`${e}/stats/${t}`)}static async getInventory(e){const t=w.get("login");if(!t.steamId)return console.warn("Must be signed in to access Inventory"),null;const s={l:"english",count:2e3};let r,a,n=null;do{const o=Object.assign(s,a?{start_assetid:a}:null);r=await G.getEndpoint(`/inventory/${t.steamId}/753/${e}`,o,(e=>{if(403===e.status)throw new c.LoginError("community")})),r&&r.success&&(n||(n={assets:[],descriptions:[]}),r.assets&&(n.assets=n.assets.concat(r.assets)),r.descriptions&&(n.descriptions=n.descriptions.concat(r.descriptions)),a=r.last_assetid)}while(r.more_items);if(!n)throw new Error(`Could not retrieve Inventory 753/${e}`);return n}static async coupons(){const e=new Map,t=await G.getInventory(3);if(!t)return null;for(const s of t.descriptions){if(!s.type||"Coupon"!==s.type)continue;if(!s.actions)continue;const t={image_url:s.icon_url,title:s.name,discount:s.name.match(/([1-9][0-9])%/)[1],id:`${s.classid}_${s.instanceid}`};s.descriptions.forEach(((e,s)=>{const r=e.value;r.startsWith("Can't be applied with other discounts.")?Object.assign(t,{discount_note:r,discount_note_id:s,discount_doesnt_stack:!0}):r.startsWith("(Valid")&&Object.assign(t,{valid_id:s,valid:r})}));for(const r of s.actions){const s=r.link.match(/[1-9][0-9]*(?:,[1-9][0-9]*)*/);if(s)for(let r of s[0].split(","))r=Number(r),(!e.has(r)||e.get(r).discount<t.discount)&&e.set(r,t);else console.warn("Couldn't find packageid(s) for link %s",r.link)}}const s=await $.get("packages",Array.from(e.keys()));for(const[t,r]of e.entries()){const e=s[t];r.appids=e||[]}return $.put("coupons",e)}static getCoupon(e){return $.getFromIndex("coupons","appid",e)}static hasCoupon(e){return $.indexContainsKey("coupons","appid",e)}static async giftsAndPasses(){const e=[],t=[];let s,r=await G.getInventory(1);if(!r)return null;function a(r){const a=z.getAppids(r.value);s=!0;for(const s of a)s&&("Gift"===r.type?e.push(s):t.push(s))}for(const n of r.descriptions){if(s=!1,n.descriptions)for(const e of n.descriptions)if("html"===e.type){a(e);break}if(!s&&n.actions){const s=z.getAppid(n.actions[0].link);s&&("Gift"===n.type?e.push(s):t.push(s))}}return r={gifts:e,passes:t},$.put("giftsAndPasses",r)}static hasGiftsAndPasses(e){return $.getFromIndex("giftsAndPasses","appid",e,{all:!0,asKey:!0})}static async items(){const e=await G.getInventory(6);return e?$.put("items",e.descriptions.map((e=>e.market_hash_name))):null}static hasItem(e){return $.contains("items",e)}static async fetchWorkshopFileSize({key:e}){const t=new DOMParser,s=await G.getPage("/sharedfiles/filedetails/",{id:e}),r=t.parseFromString(s,"text/html").querySelector(".detailsStatRight");if(!r||!r.innerText.includes("MB"))throw new Error("Couldn't find details block for workshop file size");const a=r.innerText.split(" ")[0].trim(),n=parseFloat(a.replace(/,/g,""));return $.put("workshopFileSizes",new Map([[Number(e),1e3*n]]))}static getWorkshopFileSize(e,t){return $.get("workshopFileSizes",Number(e),{preventFetch:t})}static _getReviewId(e){const t=e.querySelector("input");return Number(t?t.id.replace("ReviewVisibility",""):e.querySelector(".control_block > a").id.replace("RecommendationVoteUpBtn",""))}static async fetchReviews({key:e,params:{reviewCount:t}}){const s=new DOMParser,r=[];for(let a=1;a<=Math.ceil(t/10);a++){const t=s.parseFromString(await G.getPage(`${e}/recommended`,{p:a}),"text/html");for(const e of t.querySelectorAll(".review_box")){const t=e.querySelector(".header").innerHTML.split("<br>"),s=e.querySelector(".hours").textContent.split("(")[0].match(/(\d+,)?\d+\.\d+/),a=e.querySelector(".dselect_container:nth-child(2) .trigger"),n=G._getReviewId(e),o=e.querySelector("[src*=thumbsUp]")?1:0,i=t[0]&&t[0].match(/\d+/g)?parseInt(t[0].match(/\d+/g).join("")):0,c=t[1]&&t[1].match(/\d+/g)?parseInt(t[1].match(/\d+/g).join("")):0,l=e.querySelector(".content").textContent.trim().length,u=a?a.textContent:"Public",p=s?parseFloat(s[0].split(",").join("")):0;r.push({rating:o,helpful:i,funny:c,length:l,visibility:u,playtime:p,node:DOMPurify.sanitize(e.outerHTML),id:n})}}return $.put("reviews",{[e]:r})}static async updateReviewNode(e,t,s){const r=(new DOMParser).parseFromString(t,"text/html").querySelector(".review_box"),a=G._getReviewId(r);if(!await $.contains("reviews",e,{preventFetch:!0}))return null;const n=await $.get("reviews",e,{params:s});for(const e of n)if(e.id===a){e.node=DOMPurify.sanitize(r.outerHTML);break}return $.put("reviews",{[e]:n})}static getReviews(e,t){return $.get("reviews",e,{params:{reviewCount:t}})}static async login(e){const t=G;if(!e)throw t.logout(),new Error("Login endpoint needs a valid profile path");if(!e.startsWith("/id/")&&!e.startsWith("/profiles/"))throw t.logout(),new Error(`Could not interpret ${e} as a valid profile path`);const s=w.get("login");if(s.profilePath===e)return s;const r=await t.getPage(e),a=B.getVariableFromText(r,"g_rgProfileData","object").steamid;if(!a)throw new Error("Failed to retrieve steamID from profile");t.logout(!0);const n={steamId:a,profilePath:e};return w.set("login",n),n}static logout(e=w.has("login")){e&&(w.remove("login"),w.remove("storeCountry"),K.remove("currency"))}static storeCountry(e){return e?(w.set("storeCountry",e),null):w.get("storeCountry")}static getProfile(e){return $.get("profiles",e,{params:{profile:e}})}static clearOwn(e){return $.delete("profiles",e)}static async getPage(e,t){const s=await this._fetchWithDefaults(e,t,{method:"GET"});if("/login/home/"===new URL(s.url).pathname)throw new c.LoginError("community");return s.text()}}G.origin="https://steamcommunity.com/",G.params={credentials:"include"};class H extends U{static async fetchPackage({key:e}){const t=await H.getEndpoint("/api/packagedetails/",{packageids:e}),s=new Map;for(const[e,r]of Object.entries(t))r&&r.success?s.set(Number(e),r.data.apps.map((e=>e.id))):s.set(Number(e),null);return $.put("packages",s)}static async wishlistAdd(e){let t;const s=await H.sessionId();if(s&&(t=await H.postEndpoint("/api/addtowishlist",{sessionid:s,appid:e})),!t||!t.success)throw new Error(`Failed to add app ${e} to wishlist`);return H.clearDynamicStore()}static async wishlistRemove(e,t){let s,r=t;if(r||(r=await H.sessionId()),r&&(s=await H.postEndpoint("/api/removefromwishlist",{sessionid:r,appid:e})),!s||!s.success)throw new Error(`Failed to remove app ${e} from wishlist`);return H.clearDynamicStore()}static async currencyFromWallet(){const e=await H.getPage("/steamaccount/addfunds");return B.htmlToDOM(e).querySelector("input[name=currency]").value}static async currencyFromApp(){const e=await H.getPage("/app/220"),t=B.htmlToDOM(e).querySelector("meta[itemprop=priceCurrency][content]");if(!t||!t.getAttribute("content"))throw new Error("Store currency could not be determined from app 220");return t.getAttribute("content")}static async currency(){let e=K.get("currency");if(e)return e;if(e=await H.currencyFromWallet(),e||(e=await H.currencyFromApp()),!e)throw new Error("Could not retrieve store currency");return K.set("currency",e),e}static async country(){const e=H,t=await e.getPage("/account/change_country/",{},(e=>{if("/login/"===new URL(e.url).pathname)throw new c.LoginError("store")})),s=B.htmlToDOM(t).querySelector("#dselect_user_country");return s&&s.value}static async sessionId(){const e=H,t=await e.getPage("/about/");return B.getVariableFromText(t,"g_sessionID","string")}static async wishlists(e){const t=await H.getPage(`/wishlist${e}`),s=B.getVariableFromText(t,"g_rgWishlistData","array");return s?s.length:""}static async purchaseDate({params:e}){const t=[/- Complete Pack/gi,/Standard Edition/gi,/Steam Store and Retail Key/gi,/- Hardware Survey/gi,/ComputerGamesRO -/gi,/Founder Edition/gi,/Retail( Key)?/gi,/Complete$/gi,/Launch$/gi,/Free$/gi,/(RoW)/gi,/ROW/gi,/:/gi],s=new Map,r=await H.getPage("/account/licenses/",{l:e}),a=B.htmlToDOM(r).querySelectorAll("#main_content td.license_date_col");for(const e of a){const r=e.nextElementSibling,a=r.querySelector("div");a&&a.remove();let n=B.clearSpecialSymbols(r.textContent.trim());for(const e of t)n=n.replace(e,"");n=n.trim(),s.set(n,e.textContent)}return $.put("purchases",s)}static purchases(e,t){return $.get("purchases",e,{params:t})}static clearPurchases(){return $.clear("purchases")}static async dynamicStore(){const e=await H.getEndpoint("dynamicstore/userdata",{},null,{cache:"no-cache"}),{rgOwnedApps:t,rgOwnedPackages:s,rgIgnoredApps:r,rgWishlist:a}=e,n={ignored:Object.keys(r).map((e=>Number(e))),ownedApps:t,ownedPackages:s,wishlisted:a};return $.put("dynamicStore",n)}static dsStatus(e){return $.getFromIndex("dynamicStore","appid",e,{all:!0,asKey:!0})}static async dynamicStoreRandomApp(){const e=await $.getAll("dynamicStore");return e&&e.ownedApps?e.ownedApps[Math.floor(Math.random()*e.ownedApps.length)]:null}static async clearDynamicStore(){await $.clear("dynamicStore")}static appDetails(e,t){const s={appids:e};return t&&(s.filters=t),H.endpointFactory("api/appdetails/",e)(s)}static appUserDetails(e){return H.endpointFactory("api/appuserdetails/",e)({appids:e})}}H.origin="https://store.steampowered.com/",H.params={credentials:"include"},H._progressingRequests=new Map;class V{static async currencies(){const e=V;return(!e._supportedCurrencies||e._supportedCurrencies.length<1)&&(e._supportedCurrencies=await h.getJSON("json/currency.json")),e._supportedCurrencies}}V._supportedCurrencies=null;const J="https://api.isthereanydeal.com";class Q extends U{static async authorize(){const e=crypto.getRandomValues(new Uint32Array(1))[0],t="https://isthereanydeal.com/connectaugmentedsteam",s=new URL(`${J}/oauth/authorize/`);s.searchParams.set("client_id","5fe78af07889f43a"),s.searchParams.set("response_type","token"),s.searchParams.set("state",e),s.searchParams.set("scope",Q.requiredScopes.join(" ")),s.searchParams.set("redirect_uri",t);const r=await browser.tabs.create({url:s.toString()}),a=await new Promise(((e,s)=>{function a({url:t}){return e(t),browser.webRequest.onBeforeRequest.removeListener(a),browser.tabs.onRemoved.removeListener(n),browser.tabs.remove(r.id),{cancel:!0}}function n(e){e===r.id&&(s(new Error("Authorization tab closed")),browser.webRequest.onBeforeRequest.removeListener(a),browser.tabs.onRemoved.removeListener(n))}browser.webRequest.onBeforeRequest.addListener(a,{urls:[t,`${t}#*`],tabId:r.id},["blocking"]),browser.tabs.onRemoved.addListener(n)})),n=new URL(a).hash,o=new URLSearchParams(n.substr(1));if(parseInt(o.get("state"))!==e)throw new Error("Failed to verify state parameter from URL fragment");const i=o.get("access_token"),c=o.get("expires_in");if(!i||!c)throw new Error(`Couldn't retrieve information from URL fragment "${n}"`);w.set("access_token",{token:i,expiry:k.now()+parseInt(c)})}static disconnect(){return w.remove("access_token"),w.remove("lastItadImport"),$.clear(["collection","waitlist","itadImport"])}static isConnected(){const e=w.get("access_token");return!!e&&(e.expiry<=k.now()?(w.remove("access_token"),!1):(Q.accessToken=e.token,!0))}static endpointFactoryCached(e,t,s){return({params:r={},key:a}={})=>Q.isConnected()?super.endpointFactoryCached(e,t,s)({params:Object.assign(r,{access_token:Q.accessToken}),key:a}):null}static async addToWaitlist(e){if(!e||Array.isArray(e)&&!e.length)return console.warn("Can't add nothing to ITAD waitlist"),null;const t={version:"02",data:[]},s={};if(Array.isArray(e))e.forEach((e=>{const r=`app/${e}`;t.data.push({gameid:["steam",r]}),s[r]=null}));else{const r=`app/${e}`;t.data[0]={gameid:["steam",r]},s[r]=null}return await Q.postEndpoint("v01/waitlist/import/",{access_token:Q.accessToken},null,{body:JSON.stringify(t)}),$.put("waitlist",s)}static async removeFromWaitlist(e){if(!e||Array.isArray(e)&&!e.length)throw new Error("Can't remove nothing from ITAD Waitlist!");const t=(Array.isArray(e)?e:[e]).map((e=>`app/${e}`));return await Q.deleteEndpoint("v02/user/wait/remove/",{access_token:Q.accessToken,shop:"steam",ids:t.join()}),$.delete("waitlist",t)}static addToCollection(e,t){if((!e||Array.isArray(e)&&!e.length)&&(!t||Array.isArray(t)&&!t.length))return console.warn("Can't add nothing to ITAD collection"),null;const s={version:"02",data:[]};let r,a;r=Array.isArray(e)?e:e?[e]:[],a=Array.isArray(t)?t:t?[t]:[];const n=r.map((e=>`app/${e}`)).concat(a.map((e=>`sub/${e}`)));for(const e of n)s.data.push({gameid:["steam",e],copies:[{type:"steam",status:"redeemed",owned:1}]});return Q.postEndpoint("v01/collection/import/",{access_token:Q.accessToken},null,{body:JSON.stringify(s)})}static async import(e){if(e)await $.clear("dynamicStore");else{const e=w.get("lastItadImport");if(e&&e.to&&!$.isExpired(e.to+43200))return}const t=[],r=[];s.get("itad_import_library")&&(t.push("ownedApps","ownedPackages"),r.push("lastOwnedApps","lastOwnedPackages")),s.get("itad_import_wishlist")&&(t.push("wishlisted"),r.push("lastWishlisted"));const a=await Promise.all([$.get("dynamicStore",t),$.get("itadImport",r)]);function n(e,t){return e?t?e.filter((e=>!t.includes(e))):e:[]}const o=[];if(s.get("itad_import_library")){const[{ownedApps:e,ownedPackages:t},{lastOwnedApps:s,lastOwnedPackages:r}]=a,i=n(e,s),c=n(t,r);(i.length||c.length)&&o.push(Q.addToCollection(i,c).then((()=>$.put("itadImport",{lastOwnedApps:e,lastOwnedPackages:t}))))}if(s.get("itad_import_wishlist")){const[{wishlisted:e},{lastWishlisted:t}]=a,s=n(e,t);s.length&&o.push(Q.addToWaitlist(s).then((()=>$.put("itadImport",{lastWishlisted:e}))))}await Promise.all(o);const i=w.get("lastItadImport");i.to=k.now(),w.set("lastItadImport",i)}static async sync(){await Promise.all([Q.import(!0),$.clear("waitlist").then((()=>$.objStoreFetchFns.get("waitlist")({params:{shop:"steam",optional:"gameid"}}))),$.clear("collection").then((()=>$.objStoreFetchFns.get("collection")({params:{shop:"steam",optional:"gameid,copy_type"}})))])}static lastImport(){return w.get("lastItadImport")}static mapCollection(e){if(!e)return null;const{games:t,typemap:s}=e,r={};t.forEach((({gameid:e,types:t})=>{const a=t.map((e=>s[e]));r[e]=a}));const a=w.get("lastItadImport");return a.from=k.now(),w.set("lastItadImport",a),r}static mapWaitlist(e){if(!e)return null;const t=[];for(const{gameid:s}of Object.values(e))t.push(s);const s=w.get("lastItadImport");return s.from=k.now(),w.set("lastItadImport",s),t}static inWaitlist(e){return $.contains("waitlist",e,{params:{shop:"steam",optional:"gameid"}})}static inCollection(e){return $.contains("collection",e,{params:{shop:"steam",optional:"gameid,copy_type"}})}static getFromCollection(e){return $.get("collection",e,{params:{shop:"steam",optional:"gameid,copy_type"}})}}Q.accessToken=null,Q.requiredScopes=["wait_read","wait_write","coll_read","coll_write"],Q.origin=J,Q._progressingRequests=new Map;class Z extends U{static async getEndpoint(e,t){const s=await super.getEndpoint(e,t,(t=>{if(500===t.status)throw new c.ServerOutageError(`Augmented Steam servers are currently overloaded, failed to fetch endpoint "${e}"`)}));if(!s.result||"success"!==s.result)throw new Error(`Could not retrieve '${e}'`);return delete s.result,s}static storePageData(e,t,s){const r={appid:e};return t&&(r.mcurl=t),s&&(r.oc=1),$.get("storePageData",e,{params:r})}static expireStorePageData(e){return $.delete("storePageData",`app_${e}`)}static rates(e){return $.getAll("rates",{params:{to:e.sort().join(",")}})}static clearRates(){return $.clear("rates")}static isEA(e){return $.contains("earlyAccessAppids",e)}static steamPeek(e){return Z.endpointFactory("v01/similar")({appid:e,count:15})}}Z.origin="https://esapi.isthereanydeal.com",Z._progressingRequests=new Map;class X{static clearCache(){return K.clear(),$.clear()}static async moveNotesToSyncedStorage(){const e=Object.entries(await $.getAll("notes")),t=s.get("user_notes");for(const[s,r]of e)t[s]=r;s.set("user_notes",t)}static async getNote(e){const t=await $.get("notes",e);return void 0===t?null:t}static setNote(e,t){return $.put("notes",new Map([[e,t]]))}static deleteNote(e){return $.delete("notes",e)}static getAllNotes(){return $.getAll("notes")}static async setAllNotes(e){await X.clearNotes();const t=new Map(Object.entries(e).map((([e,t])=>[Number(e),t])));return $.put("notes",t)}static clearNotes(){return $.clear("notes")}}$.objStoreFetchFns=new Map([["coupons",G.coupons],["giftsAndPasses",G.giftsAndPasses],["items",G.items],["workshopFileSizes",G.fetchWorkshopFileSize],["reviews",G.fetchReviews],["purchases",H.purchaseDate],["dynamicStore",H.dynamicStore],["packages",H.fetchPackage],["earlyAccessAppids",Z.endpointFactoryCached("v01/earlyaccess","earlyAccessAppids")],["storePageData",Z.endpointFactoryCached("v01/storepagedata","storePageData")],["profiles",Z.endpointFactoryCached("v01/profile/profile","profiles")],["rates",Z.endpointFactoryCached("v01/rates","rates")],["collection",Q.endpointFactoryCached("v02/user/coll/all","collection",Q.mapCollection)],["waitlist",Q.endpointFactoryCached("v01/user/wait/all","waitlist",Q.mapWaitlist)]]);const Y=new Map([["wishlist.add",H.wishlistAdd],["wishlist.remove",H.wishlistRemove],["dynamicstore.clear",H.clearDynamicStore],["steam.currencies",V.currencies],["migrate.cachestorage",K.migrate],["migrate.notesToSyncedStorage",X.moveNotesToSyncedStorage],["notes.get",X.getNote],["notes.set",X.setNote],["notes.delete",X.deleteNote],["notes.getall",X.getAllNotes],["notes.setall",X.setAllNotes],["notes.clear",X.clearNotes],["cache.clear",X.clearCache],["dlcinfo",Z.endpointFactory("v01/dlcinfo")],["storepagedata",Z.storePageData],["storepagedata.expire",Z.expireStorePageData],["prices",Z.endpointFactory("v01/prices")],["rates",Z.rates],["clearrates",Z.clearRates],["isea",Z.isEA],["profile.background",Z.endpointFactory("v01/profile/background/background")],["profile.background.games",Z.endpointFactory("v01/profile/background/games")],["twitch.stream",Z.endpointFactory("v01/twitch/stream")],["market.cardprices",Z.endpointFactory("v01/market/cardprices")],["market.averagecardprices",Z.endpointFactory("v01/market/averagecardprices")],["steampeek",Z.steamPeek],["appdetails",H.appDetails],["appuserdetails",H.appUserDetails],["currency",H.currency],["sessionid",H.sessionId],["wishlists",H.wishlists],["purchases",H.purchases],["clearpurchases",H.clearPurchases],["dynamicstorestatus",H.dsStatus],["dynamicStore.randomApp",H.dynamicStoreRandomApp],["login",G.login],["logout",G.logout],["storecountry",G.storeCountry],["cards",G.cards],["stats",G.stats],["coupon",G.getCoupon],["hasgiftsandpasses",G.hasGiftsAndPasses],["hascoupon",G.hasCoupon],["hasitem",G.hasItem],["profile",G.getProfile],["clearownprofile",G.clearOwn],["workshopfilesize",G.getWorkshopFileSize],["reviews",G.getReviews],["updatereviewnode",G.updateReviewNode],["itad.authorize",Q.authorize],["itad.disconnect",Q.disconnect],["itad.isconnected",Q.isConnected],["itad.import",Q.import],["itad.sync",Q.sync],["itad.lastimport",Q.lastImport],["itad.inwaitlist",Q.inWaitlist],["itad.addtowaitlist",Q.addToWaitlist],["itad.removefromwaitlist",Q.removeFromWaitlist],["itad.incollection",Q.inCollection],["itad.getfromcollection",Q.getFromCollection],["error.test",()=>Promise.reject(new Error("This is a TEST Error. Please ignore."))]]);browser.runtime.onMessage.addListener((async(e,t)=>{if(!t||!t.tab)return null;if(!e||!e.action)return null;const a=Y.get(e.action);if(!a)throw new Error(`Did not recognize "${e.action}" as an action.`);let n;e.params=e.params||[];try{await Promise.all([$,K,w,s.then((()=>{!function(){if(r)return;r=!0;const e={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|chrome-extension|moz-extension|steam):|[^a-z]|[a-z+.-]+(?:[^a-z+.\-:]|$))/i};s.get("openinnewtab")&&(e.ADD_ATTR=["target"],DOMPurify.addHook("uponSanitizeAttribute",((e,t)=>{"target"===t.attrName&&("_blank"===t.attrValue?e.setAttribute("rel","noreferrer noopener"):t.keepAttr=!1)}))),DOMPurify.setConfig(e)}()}))]),n=await a(...e.params)}catch(t){throw console.group(`Callback: "${e.action}"`),console.error('Failed to execute callback "%s" with params %o',e.action,e.params),console.error(t),console.groupEnd(),new Error(t.toString())}return n})),browser.runtime.onStartup.addListener(b.update),browser.runtime.onInstalled.addListener(b.update),_.when("contextMenus",(()=>{browser.contextMenus.onClicked.addListener(b.onClick)}),(()=>{browser.contextMenus.onClicked.removeListener(b.onClick)}))})();
//# sourceMappingURL=background.js.map