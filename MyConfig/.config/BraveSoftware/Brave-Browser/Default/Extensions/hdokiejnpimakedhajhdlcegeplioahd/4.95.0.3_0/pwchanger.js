function PWCHANGER(){var m=2,k="",w=[],v="",b="",T="",S="",P="",E="",A=0,O=0,x="",C="",R=[],I=100100,j=10,u="",h=[],K=!1,N=!1,H=!1,_="";function F(){return"undefined"!=typeof $?$.ajax:LPPlatform.doAjax}function g(t,a,r,i,o,e,s,n,u,c,d,l,p,f,y){var _=void 0!==p?p:"",h,g;void 0!==f&&f&&(j=f),void 0!==d&&null!=d||(d=""),"function"!=typeof s&&(s=function(){}),x=d,C=l,k=n,"function"==typeof u&&u(0,0),L(r,a,i,e,function(e){if("string"==typeof e)if("usernametaken"!=e){"function"==typeof u&&u(0,1);var n={oldkey:t,oldkey1:_,oldpwhash:a,oldemail:r,newemail:i,newpassword:o,callback:s,reencrypt:e,status:u,foundendmarker:!1};y&&(n.ks="true"),R=n,setTimeout(function(){W()},0)}else s(1,!1,!1,"B : Username Taken");else s(4,!1,!1,"A : Invalid Response")},function(e,n,t){s(2,!1,!1,"C : "+n+" suberror="+t)},c)}function L(a,r,i,o,s,u,c){var e=function(){var e=void 0!==r&&null!=r&&""!=r?{wxusername:a,wxhash:r}:{};void 0!==c&&null!=c&&""!=c&&(e.vendor=c);var n=k+"getaccts.php?changepw=1&changepw2=1&includersaprivatekeyenc=1&changeun="+(a!=i?encodeURIComponent(i):"")+"&resetrsakeys="+(o?"1":"0")+"&includeendmarker=1",t;"undefined"!=typeof g_recovery_uid&&(n+="&recovery_uid="+encodeURIComponent(g_recovery_uid)),F()({url:n,type:"POST",data:e,timeout:3e5,success:"function"==typeof s?s:null,error:"function"==typeof u?u:null})};n(function(){t(function(){e()},u)},u)}function X(l,p,f,y,_){""===f&&y();var e=x||token,n;F()({url:k+"lmiapi/one-time-password",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({masterPasswordHash:f}),headers:{"X-CSRF-TOKEN":e},success:function(n,t){if("object"==typeof n.oneTimePasswords)if(h=[],0!==n.oneTimePasswords.length){var e=[];try{for(var a=fix_username(R.newemail),r=0;r<n.oneTimePasswords.length;r++){var i=n.oneTimePasswords[r],o={},s=dec(i.encryptedOneTimePassword,l),u=AES.hex2bin(s),c=make_lp_hash(a,u),d=make_lp_key(a,u);i.oneTimePasswordHash=c,i.randomEncryptedKey=enc(AES.bin2hex(l),d),o.encryptedOneTimePassword=enc(s,p),o.randomEncryptedKey=enc(AES.bin2hex(p),d),o.oneTimePasswordHash=c,e.push(o),h.push(i)}}catch(e){return void("function"==typeof _&&_(n,t,"OTP Encryption failed"))}G(e,f,y,_)}else"function"==typeof y&&y();else"function"==typeof _&&_(n,t,"Invalid one time password response")},error:function(e,n){"function"==typeof _&&_(e,n,"GET one time passwords failed")}})}function D(e){0!==h.length?G(h,pwhash,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function G(e,n,t,a){""===n&&t();var r=JSON.stringify({oneTimePasswords:e,masterPasswordHash:n}),i=x||token,o;F()({url:k+"lmiapi/one-time-password/update",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":i},data:r,dataType:"json",success:t,error:function(e,n){"function"==typeof a&&a(e,n,"POST new one time passwords failed")}})}function U(r,i,o,s){var e=x||token,n;F()({url:k+"lmiapi/authenticator/backup",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":e},success:function(n,t){var e;try{u=n.userData;var a=dec(n.userData,r);e=enc(a,i)}catch(e){return void("function"==typeof s&&s(n,t,"Encryption failed"))}c(e,o,s)},error:function(e,n){e.status&&404==e.status?"function"==typeof o&&o():"function"==typeof s&&s(e,n,"GET new LP cloud backup failed")}})}function J(e){u?c(u,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function c(e,n,t){var a=JSON.stringify({userData:e}),r=x||token,i;F()({url:k+"lmiapi/authenticator/backup",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":r},data:a,dataType:"json",success:n,error:function(e,n){"function"==typeof t&&t(e,n,"POST new LP cloud backup failed")}})}function B(){var e=null,n=R.callback;"function"==typeof n&&n(2,!1,!1,e)}function W(){try{if(2==m){w=R.reencrypt.split("\n"),"number"==typeof g_target_key_iterations&&(I=g_target_key_iterations,"undefined"!=typeof g_key_iterations&&g_key_iterations!=g_target_key_iterations&&(R.iterationschange="1")),P=R.newkey||make_lp_key_iterations(fix_username(R.newemail),R.newpassword,I),v+=w[0]+"\n";var e=w[1];if(""!=e){var n=rsa_extract_privatekey(e,R.oldkey);""==n&&""!=R.oldkey1&&(n=rsa_extract_privatekey(e,R.oldkey1)),_=""==n?(b="","failed"):(b=rsa_encrypt_privatekey(n,P),n=null,"success"),T=SHA256(AES.bin2hex(P).toUpperCase()),S=SHA256(b)}}if(void 0===w.length)return void R.callback(2,!1,!1,"F2 : internal error");var t,a,r=!1;try{enc(" ",P)&&(r=!0)}catch(e){}for(var i=m+3;m<w.length&&m<i;++m){var o,s=w[m].replace(/\r\n|\r|\n/g,"").split("\t");if(l=s[0],"endmarker"!=l){var u=void 0!==s.length&&2<=s.length&&"0"==s[1];if(void 0!==l.length&&l.length){var c=null;if(r)try{t=dec(l,R.oldkey),a=enc(t,P)}catch(e){c=e}if(!r||null!=c||!AES.ok(a)||0==a.length||null==t||void 0===t.length||0==t.length){if(!u){if(r)null!=(t=dec(l,P))&&void 0!==t.length&&0!=t.length||(E+="enc: "+l+" decrypted:  reencrypted to: "+a+(null==c?"":" : EXCEPTION_A!")+"\n");else{var d=void 0===P.length?"undefined":P.length;E+="encrypting <space> using m_newkey (m_newkey.length="+d+") resulted in EXCEPTION_B!\n"}A++}a=r?l:""}u||O++,v+=l+":"+a+"\n","function"==typeof R.status&&R.status(1,(m-1)/(w.length-2))}}else R.foundendmarker=!0}if(m<w.length)return void setTimeout(function(){W()},0);if(!R.foundendmarker)return void("function"==typeof R.callback&&R.callback(2,!1,!1,"D : Data download not complete"));void 0!==j&&j||(j=10);var p=x||token;if(""!=E&&O/100*j<=A){var f={from:"passwordChange",errors:E,username:R.oldemail,private_key_status:_,total:w.length-2,mandatory_total:O,mandatory_failed:A,super_admin_reset:N?"yes":"no"},y;return F()({url:k+"debug.php",data:f,type:"POST",timeout:6e5,headers:{"X-CSRF-TOKEN":p},success:function(e){},error:function(e,n){}}),void("function"==typeof R.callback&&R.callback(3,null,null,"E : "+E))}"function"==typeof tracelog&&tracelog("Re encryption finished."),U(R.oldkey,P,function(){R.iterationschange?X(R.oldkey,P,R.oldpwhash,M,B):M()},B)}catch(e){R.callback(2,!1,!1,"F : "+e.message)}}this.hashMigration=function(t,a,r,i,o,e,n,s,u,c){if(void 0===c&&(c=""),K=H=N=!1,k=e,x=n,I=s,j=0,"function"!=typeof u&&(u=function(){}),t!==i){var d=function(e,n,t,a){0===e?u(!0):u(!1,a)},l,p;L(r,a,r,!1,function(e){var n;"string"==typeof e?"usernametaken"!=e?(R={oldkey:t,oldkey1:c,oldpwhash:a,oldemail:r,newemail:r,newkey:i,newpwhash:o,callback:d,reencrypt:e,foundendmarker:!1,iterationschange:"1",hashmigration:"1"},setTimeout(function(){W()},0)):u(!1,"Username taken or deleted during hash migration"):u(!1,"Invalid response")},function(){u(!1,"Error retrieving accounts data during hash migration")})}else u(!1,"Hash migration already happened? Maybe stale extension data")},this.recoveryChangePassword=function(e,n,t,a,r,i,o,s){var u="",c,d=H=N=!(K=!0);g(e,n,t,t,a,!1,r,"",i,null,o,s)},this.superAdminPasswordReset=function(e,n,t,a,r,i,o,s){var u="",c,d="",l=H=!(N=!(K=!1));g(e,"",n,t,a,!1,r,"",i,null,o,s)},this.setInitialPassword=function(e,n,t,a,r,i,o,s){var u="",c,d="",l=!(H=!(N=K=!1));g(e,"",n,t,a,!1,r,"",i,null,o,s)},this.changepw=function(e,n,t,a,r,i,o,s,u,c,d,l,p,f,y){H=N=K=!1,g(e,n,t,a,r,i,o,s,u,c,d,l,p,f,y)};var n=function(n,t){var e;Array.isArray(window.g_su_pubkeys)&&Array.isArray(window.g_su_uids)?n():F()({url:k+"lmiapi/users/me/publicsharingkeys",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":x},success:function(e){window.g_su_pubkeys=e.map(function(e){return e.publicSharingKey}),window.g_su_uids=e.map(function(e){return e.userId}),n&&n()},error:function(e,n){B(),t&&t(e,n,"Cannot GET sharing keys")}})},t=function(t,a){var e;Array.isArray(window.g_lu_pubkeys)&&Array.isArray(window.g_lu_uids)?t():(window.g_lu_pubkeys=[],window.g_lu_uids=[],F()({url:k+"lmiapi/emergency-access/sharees",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":x},success:function(e){e.forEach(function(e){window.g_lu_pubkeys.push(e.publicSharingKey),window.g_lu_uids.push(e.userId)}),t&&t()},error:function(e,n){404!==e.status?(B(),a&&a(e,n,"Request for emergency access keys failed")):t()}}))};function M(){"function"==typeof tracelog&&tracelog("Update data to server.");var e=R.newpwhash||make_lp_hash_iterations(P,R.newpassword,I),a={reencrypt:v,newprivatekeyenc:b,newuserkeyhexhash:T,newprivatekeyenchexhash:S,newpasswordhash:e,pwupdate:"1",email:R.newemail,token:x,encrypted_username:encecb(R.newemail,P),origusername:R.oldemail,key_iterations:I};if(R.iterationschange&&(a.iterationschange=R.iterationschange),R.hashmigration&&(a.hashmigration=R.hashmigration,a.ks=!0),K&&(a.is_recovery="1"),N&&(a.superAdminReset="1",g_converttosftargetuid)){var n=make_lp_key_iterations(R.newemail,R.newpassword,I),t=make_lp_hash_iterations(n,R.newpassword,I);if(a.converttosfbythissharename=lpenc("Shared-SF from deleted "+R.newemail+" "+g_recovery_uid,n),a.converttosfbythispasswordhash=t,"undefined"!=typeof g_sasf_uids&&"undefined"!=typeof g_sasf_pubkeys&&"undefined"!=typeof g_sasf_uids_cnt){for(var r=0;r<g_sasf_uids_cnt;r++){var i=new RSAKey;parse_public_key(i,g_sasf_pubkeys[r])||lpmessagebox(gs("An Error Occurred"),gs("We are sorry, an error occurred - Cannot parse public key."));var o=i.encrypt(AES.bin2hex(n));a["adminsharekey"+r]=o,a["adminuid"+r]=g_sasf_uids[r]}a.adminuidcnt=g_sasf_uids_cnt}var s=new RSAKey;parse_public_key(s,g_targetuid_pubkey)?(a.converttosfbythistargetuid=g_converttosftargetuid,a.converttosfbythistargetuidsharekey=s.encrypt(AES.bin2hex(n))):lpmessagebox(gs("An Error Occurred"),gs("We are sorry, an error occurred - Cannot parse public key."))}if(H&&(a.setInitialPassword="1"),void 0!==R.oldpwhash&&null!=R.oldpwhash&&""!=R.oldpwhash&&(a.wxusername=R.oldemail,a.wxhash=R.oldpwhash),void 0!==R.ks&&R.ks&&(a.ks="true"),void 0!==C&&null!=C&&(a.password_hint=C),"undefined"!=typeof g_su_pubkeys&&null!=g_su_pubkeys&&g_su_pubkeys.length){for(var u=!1,c=0,d=0;d<g_su_pubkeys.length;d++)if(""!=g_su_pubkeys[d]){var i=new RSAKey;parse_public_key(i,g_su_pubkeys[d])&&(a["sukey"+c]=i.encrypt(AES.bin2hex(P)),a["suuid"+c]=g_su_uids[d],u=!0,c++)}if(a.sukeycnt=c,0==u&&"function"==typeof R.callback)return void R.callback(2,!1,!1,gs("Before your LastPass administrator can set up account recovery, all users who are Administrators must log in to a browser extension at least once."))}if("undefined"!=typeof g_lu_pubkeys&&null!=g_lu_pubkeys){var c=0;g_lu_pubkeys.forEach(function(e,n){if(e){var t=new RSAKey;parse_public_key(t,e)&&(a["lukey"+c]=t.encrypt(AES.bin2hex(P)),a["luuid"+c]=g_lu_uids[n],c++)}}),a.lukeycnt=c}"undefined"!=typeof g_recovery_uid&&(a.recovery_uid=g_recovery_uid),"undefined"!=typeof g_changeiterations&&1==g_changeiterations&&(a.iterationschange="1"),"undefined"==typeof g_sapr_pwd||"undefined"==typeof g_sapr_newpwd||g_converttosftargetuid||(a.to_be_federated=1,a.fed_keyALP=g_sapr_keyALP,a.fed_keyLP=g_sapr_keyLP,a.fed_keyLPCheckHash=g_sapr_keyLPCheckHash,a.fed_fragmentId=g_sapr_fragmentId,a.fed_pwdlastset=g_sapr_lastPwdSet),document.URL.includes("familiesinvite=1")&&(a.familiesinvite=1),"undefined"!=typeof fromcid&&(a.cid=fromcid),"undefined"!=typeof g_oid_fragmentId&&(a.fedOId_fragmentId=g_oid_fragmentId),"undefined"!=typeof g_isFederatedEmailChng&&(a.fedEmailChange=g_isFederatedEmailChng);var l=R.callback,p=P,f=R.newemail,y=R.status;R=new Array,w=new Array,m=2,E=P=v="",O=A=0,"function"==typeof y&&y(2,0);var _=generateOtpData(f,p),h=F();_.lmiapiData.masterPasswordHash=a.wxhash,h({url:k+"lmiapi/one-time-password/add",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(_.lmiapiData),headers:{"X-CSRF-TOKEN":a.token},success:function(){localStorage.setItem(SHA256(f)+"_otp",AES.bin2hex(_.OTP)),g(_.lmiapiData.oneTimePasswordHash)},error:function(){g()}});var g=function(e){e&&(a.not_to_be_deleted_otp_hash=e),h({url:k+"settings.php",data:a,type:"POST",timeout:6e5,success:function(e){"function"==typeof y&&y(2,1),-1!=e.indexOf("pwchangeok")?"function"==typeof l&&l(0,p,f):0<=e.indexOf("reusepass")?J(function(){D(function(){l(2,!1,!1,"H : "+e.split("\n")[1])})}):0==e.indexOf("error\n")?J(function(){D(function(){l(2,!1,!1,e.split("\n")[1])})}):J(function(){D(function(){l(2,!1,!1,"I : An error occured")})})},error:function(e,n,t){J(function(){D(function(){"function"==typeof l&&l(2,!1,!1,"J : "+n+" suberror="+t)})})}})}}}String.prototype.includes||(String.prototype.includes=function(e,n){"use strict";return"number"!=typeof n&&(n=0),!(n+e.length>this.length)&&-1!==this.indexOf(e,n)});