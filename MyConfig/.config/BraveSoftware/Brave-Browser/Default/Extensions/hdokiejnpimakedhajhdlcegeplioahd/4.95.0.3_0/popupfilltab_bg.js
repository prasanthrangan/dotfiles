var LPIF={},g_popupfill_hint={},g_popupfill_hint_generate={},g_popupfill_hint_save={},g_popupfill_hint_type={},g_popupfill_last_active={},g_popupfill_last_active_fieldid={},g_popupfill_last_active_fieldtype={},g_popupfill_save_data={},g_popupfill_pw_challenge=null,g_popupforminput=[],g_popupform_active=[],g_popupform_active_choose=[],g_popupform_more_open=[],g_popupform_shownavbar=[],g_show_save_success_msg=!0,g_popup_tabid_save=null,g_popup_tab_docnum=[],g_popup_url_by_tabid=[],g_iframe_hack_src=[];function savesiteicon_real(e,p){void 0!==g_popup_tab_docnum[e]?sendCS(e,{cmd:"savesiteiframe"},g_popup_tab_docnum[e]):sendCS(e,{cmd:"savesiteiframe"}),g_popup_tabid_save=e}function toplevelpopupsetstate(e,p){var t=p?1:0;null!=e?sendCS(e,{cmd:"toplevelpopupsetstate",toplevel_exists:t},"all"):get_selected_tab(null,function(e){var p=gettabid(e);sendCS(p,{cmd:"toplevelpopupsetstate",toplevel_exists:t},"all")})}function closepopuptoplevel_handler(e,p){var t;null!=e?(closeclickables(e,!1),toplevelpopupsetstate(e,!1),clear_popup_heartbeat(e),delete g_iframe_hack_src[e]):(get_selected_tab(null,function(e){var p=!1,t=gettabid(e);closeclickables(t,p),toplevelpopupsetstate(t,!1),clear_popup_heartbeat(t)}),g_iframe_hack_src=[])}function createpopuptoplevel_handler(e,p){var t=g_CS_tops[e];sendCS(e,{cmd:"createpopuptoplevel",from_iframe:p},t),toplevelpopupsetstate(e,!0),g_iframe_hack_src[e]=p.url,has_popup_heartbeat(e)||(do_popup_heartbeat(e),popup_heartbeat_fn(e))}function do_searchvault(e,p,t){switch(e=e&&e.toLowerCase().trim(),p){case"sites":var _={},o={},r="",a=g_popup_url_by_tabid[t];for(var i in a&&(r=lp_gettld_url(a)),g_sites)!check_ident_aid(g_sites[i].aid)||g_sites[i].tld!==r||e&&-1===g_sites[i].name.toLowerCase().indexOf(e)&&-1===g_sites[i].unencryptedUsername.toLowerCase().indexOf(e)||(_[i]=g_sites[i],g_sites[i].tld&&g_bigsquareicons[g_sites[i].tld]&&(o[i]="data:image/png;base64,"+g_bigsquareicons[g_sites[i].tld]));return JSON.stringify({sites:_,bigicons:o});case"formfills":for(var n=new Array,i=0;i<g_formfills.length;i++)check_ident_ffid(g_formfills[i].ffid)&&-1!==g_formfills[i].decprofilename.toLowerCase().indexOf(e)&&(n[n.length]=g_formfills[i]);return JSON.stringify({formfills:n})}}function do_getpopupfilldata(e){return e?(g_datacache[e].popuphtml,g_iframe_safe_to_close[e]=!0,cobble_popup_iframe_data(e)):{}}function do_getpopupfillsites(e,p){if(!e||!p)return!1;var t=p.tld,_=p.url,o=p.docnum;verbose_log("get ste & form fill data for tld="+t+" url="+_+" docnum="+o);var r="",a="",i="",n=assemble_popup_data_payload(_,t);return n&&n.sites&&(r=n.sites),n&&n.favicons&&(a=n.favicons),n&&n.formfills&&(i=n.formfills),sendCS(e,{cmd:"gotpopupfillsites",sites:r,formfills:i,favicons:a},"all"),!0}function do_setpopupfilllastactive(e,p){return!(!e||!p)&&(g_popupfill_last_active[e]=p.active,g_popupfill_last_active_fieldid[e]=p.activefieldid,g_popupfill_last_active_fieldtype[e]=p.activefieldtype,void 0!==p.ask_generate&&(g_popupfill_hint_generate[e]=p.ask_generate),void 0!==p.opentosave&&(g_popupfill_hint_save[e]=p.opentosave),void 0!==p.start_type&&(g_popupfill_hint_type[e]=p.start_type),!0)}function assemble_popup_data_payload(e,p){var t=[],_={},o={},r="",a="",i="",n="",l=new Array,f={};p=p||lp_gettld_url(e),t=getsites(e),t=reorderOnURL(t,e,!0);for(var s=0;s<t.length;s++)_[t[s].aid]=geticonurlfromrecord(t[s]),f[t[s].aid]=getbigsquareiconurlfromrecord(t[s]);for(var u=0;u<g_formfills.length;u++)if(check_ident_ffid(g_formfills[u].ffid)){l[l.length]=g_formfills[u];var g=lpmdec_acct(g_formfills[u].ccnum,!0,g_formfills[u],g_shares);if(_[g_formfills[u].ffid]=geticonCCnum(g),f[g_formfills[u].ffid]=geticonCCnum(g,!0),""!==g_formfills[u].ccnum){var c=lpmdec(g_formfills[u].ccnum);l[l.length-1].formattedCCNum=LPCC.getFormattedNumber(c),l[l.length-1].ccType=LPCC.getCCType(c)}}var d=LPJSON.stringify("");return l&&0<l.length&&(d=LPJSON.stringify(l)),n=cache_usernames(t),r=d,a=LPJSON.stringify(_),g_40fieldicon&&(i=LPJSON.stringify(f)),n&&(o.sites=n),r&&(o.formfills=r),a&&(o.favicons=a),i&&(o.bigicons=i),o}function cobble_popup_iframe_data(e){var p=LPJSON.stringify({}),t=LPJSON.stringify({}),_=LPJSON.stringify({}),o=LPJSON.stringify({}),r="",a=0,i=0,n="",l="";if(null!=e){null!=g_popupfill_hint[e]&&null!=g_popupfill_last_active[e]&&null!=g_popupfill_hint[e][g_popupfill_last_active[e]]&&(r=g_popupfill_hint[e][g_popupfill_last_active[e]]),g_popupfill_hint_generate[e]&&(a=g_popupfill_hint_generate[e]),g_popupfill_hint_save[e]&&(i=g_popupfill_hint_save[e]),g_popupfill_hint_type[e]&&(l=g_popupfill_hint_type[e]),void 0!==g_popupfill_last_active_fieldtype[e]&&(n=g_popupfill_last_active_fieldtype[e]);var f=g_popup_url_by_tabid[e],s=assemble_popup_data_payload(f);s&&s.sites&&(p=s.sites),s&&s.favicons&&(t=s.favicons),s&&s.formfills&&(o=s.formfills),s&&s.bigicons&&(_=s.bigicons)}a=a?1:0,i=i?1:0;var u=can_copy_to_clipboard()?1:0,g={ff_firstname_regexp:get_ff_translation("ff_firstname_regexp"),ff_middlename_regexp:get_ff_translation("ff_middlename_regexp"),ff_lastname_regexp:get_ff_translation("ff_lastname_regexp"),ff_username_regexp:get_ff_translation("ff_username_regexp"),ff_email_regexp:get_ff_translation("ff_email_regexp"),ff_zip_regexp:get_ff_translation("ff_zip_regexp"),ff_currpass_regexp:get_ff_translation("ff_currpass_regexp"),ff_search_regexp:get_ff_translation("ff_search_regexp"),ff_captcha_regexp:get_ff_translation("ff_captcha_regexp"),ff_bankacctnum_regexp:get_ff_translation("ff_bankacctnum_regexp"),ff_company_regexp:get_ff_translation("ff_company_regexp"),ff_password_regexp:get_ff_translation("ff_password_regexp"),ff_question_answer_regexp:get_ff_translation("ff_question_answer_regexp"),ff_address1_regexp:get_ff_translation("ff_address1_regexp"),ff_city_regexp:get_ff_translation("ff_city_regexp"),ff_forgot_regexp:get_ff_translation("ff_forgot_regexp"),ff_country_regexp:get_ff_translation("ff_country_regexp")},c=get_sitepwlen(lp_gettld_url(f));null!==c&&"string"!=typeof c||(c=0);var d=-1,m;return g_possiblemax_tuple!==[]&&g_possiblemax_tuple[0]==e&&(d=g_possiblemax_tuple[1],g_possiblemax_tuple=[]),{cmd:"gotpopupfilldata",sites:p,favicons:t,formfills:o,popuphtml:g_datacache[e].popuphtml,url:f,rowtype:r,ask_generate:a,can_copy_clipboard:u,username:g_username,inputtype:n,ask_save:i,maxpwlen:d,start_type:l,has_view_pw_challenge:g_prompts.view_pw_prompt?1:0,has_view_site_challenge:g_prompts.edit_site_prompt||g_prompts.company_copyview_site_prompt?1:0,has_view_ff_challenge:g_prompts.view_ff_prompt||g_prompts.company_copyview_site_prompt?1:0,site_pwlen:c,reg_obj:g,do_40fieldicon:g_40fieldicon,bigicons:_,ftd:frame_and_topdoc_has_same_domain(e),enable_exper:g_isadmin||"undefined"!=typeof verbose&&verbose}}function doPopupIconHint(e,p,t){return!!e&&(sendCS(e,{cmd:"popupfilliconnumber",sitenumber:p,formfillsnumber:t},"all"),!0)}function savesite_from_iframe(e,p){if(!lploggedin)return null;var t=punycode.URLToASCII(e.url);if(g_popup_url_by_tabid[p]&&(t=g_popup_url_by_tabid[p]),!check_for_frame_mismatch_ok(p,!0,gs("Are you sure you would like to save a new site to your LastPass vault?"),"savesite"))return null;var _=e.formdata2,o=e.name,r=e.group,a=e.username,i=e.password,n="",l=e.orig_username,f=e.orig_password,s=null!=_&&0<_.length,u=issharedfolder(g_shares,r);if(!checkreadonly(u))return{error:gs("Sorry, this shared folder is read-only.")};var g=0==u?g_local_key:u.sharekey,c=createNewAcct(),d=lp_gettld_url(AES._utf8_encode(t));c.genpw=!1,c.name=o,c.group=r,c.url=AES._utf8_encode(t),c.tld=d,c.unencryptedUsername=a,c.username=lpmenc(a,!0,g),c.password=lpmenc(i,!0,g),c.extra="",c.fav=0,c.autologin=0,c.never_autofill=0,c.pwprotect=0,c.aid="0",0!=u&&(c.sharefolderid=u.id,0==u.give&&(c.sharedfromaid=1));var m=r;u&&(m=r.substr(u.decsharename.length+1)),c.fields=new Array,c.save_all=e.save_all?1:0;var v=[],h={save_all:0,username:l,password:f,new_username:a,new_password:i,fromiframe:1},b=updateAndEncryptData(_,c.fields,v,c,g,h),y="name="+en(lpenc(o,g))+"&grouping="+en(lpenc(m,g))+"&data="+en(bin2hex(b))+"&extra="+en(lpenc("",g));return y+="&extjs=1&localupdate=1",y+=0==u?"":"&sharedfolderid="+en(u.id),e.source&&(y+="&source="+e.source),c.newvalues=v,s?(y+="&ref="+en(AES.url2hex(t)),saveSiteFromSubmit(y,c)):(y+="&aid=0",y+="&url="+en(AES.url2hex(t)),y+="&openid_url=",y+="&username="+en(crypto_btoa(c.username)),y+="&password="+en(crypto_btoa(c.password)),saveSite(y,c)),"fidelity.com"==c.tld?refreshsites():fill({tabid:p,acct:c,desc:"fill_A4"}),{}}var g_iframe_safe_to_close={};function savesite_dialog_changed_handler(e,p){void 0!==p.value&&(g_iframe_safe_to_close[e]=!p.value)}function iframe_close_request_handler(e,p){var t=0,_=1,o=2,r=4,a=5,i=6,n=7,l=p.initiate_timestamp,f=0;return f=g_iframe_safe_to_close&&g_iframe_safe_to_close[e]?4:g_iframe_safe_to_close&&!1===g_iframe_safe_to_close[e]&&lploggedin?1:7,sendCS(e,{cmd:"iframe_close_ack",value:f,initiate_timestamp:l,ack_timestamp:LPPerl.time()},"all"),f}function do_popupfillscreateack(e){return!(!e||!lploggedin)&&(void 0!==g_popup_tab_docnum[e]?sendCS(e,{cmd:"popupfillscreateack"},g_popup_tab_docnum[e]):sendCS(e,{cmd:"popupfillscreateack"},"all"),has_popup_heartbeat(e)||(do_popup_heartbeat(e),popup_heartbeat_fn(e)),sendLpImprove("infieldopen",{source:"form"}),!0)}function do_iframescrollenable(e){return!!e&&(sendCS(e,{cmd:"iframescrollenable",href:data.href},g_CS_tops[e]),verbose_log("set scrolling=auto for iframe on tabid "+e),sendCS(e,{cmd:"iframebodyscrollenable",href:data.href},"all"),!0)}function do_popupregister(e,p){return!(!e||!p)&&(g_popup_tab_docnum[e]=p.docnum,null!==e&&void 0!==g_iframe_hack_src[e]?g_popup_url_by_tabid[e]=g_iframe_hack_src[e]:g_popup_url_by_tabid[e]=p.url,!0)}function do_setpopupfillhint(e,p){return!(!e||!p)&&(null!=p.formid&&""!=p.formid||(p.formid="none"),null!=p.rowtype&&""!=p.rowtype||(p.rowtype="sites"),null==g_popupfill_hint[e]&&(g_popupfill_hint[e]={}),p.ask_generate?g_popupfill_hint_generate[e]=p.ask_generate:g_popupfill_hint_generate[e]=!1,g_popupfill_hint[e][p.formid]=p.rowtype,verbose_log("["+e+"] set hint on "+p.formid+" to "+p.rowtype),!0)}function do_popupfillinputsave(e,p){return!(!e||!p)&&(null==g_popupforminput&&(g_popupforminput={}),null==g_popupforminput[e]&&(g_popupforminput[e]={}),null==p.inputstr||0==p.inputstr.length?g_popupforminput[e].value="":g_popupforminput[e].value=p.inputstr,null==p.inputid||0==p.inputid.length?g_popupforminput[e].id="":g_popupforminput[e].id=p.inputid,null==p.issaveall||0==p.issaveall.length?g_popupforminput[e].issaveall="":g_popupforminput[e].issaveall=p.issaveall,null==p.inputtype||0==p.inputtype.length?g_popupforminput[e].inputtype="":g_popupforminput[e].inputtype=p.inputtype,!0)}var g_popup_heartbeat={};function do_popup_heartbeat(e){return g_popup_heartbeat=g_popup_heartbeat||{},!!e&&(g_popup_heartbeat[e.toString()]=!0)}function has_popup_heartbeat(e){return g_popup_heartbeat?!!e&&!0===g_popup_heartbeat[e.toString()]:!(g_popup_heartbeat={})}function popup_heartbeat_fn(e,p){return!!e&&(p=p||1,doPopupResize(e,-1,-1),!!has_popup_heartbeat(e)&&(setTimeout(function(){popup_heartbeat_fn(e,p+1)},1099),!0))}function clear_popup_heartbeat(e){return!!e&&!((g_popup_heartbeat=g_popup_heartbeat||{})[e.toString()]=!1)}function closeclickables(e,p){var t=p?"true":"false";null!=e?sendCS(e,{cmd:"closeclickables",force:t,lploggedin:lploggedin},"all"):get_selected_tab(null,function(e){var p=gettabid(e);sendCS(p,{cmd:"closeclickables",force:t,lploggedin:lploggedin},"all")}),do_popupkbdnavreset(e)}function closeallclickables(e){var _=e?"true":"false";get_all_windows({populate:!0},function(e){for(var p=0;p<e.length;p++)for(var t=0;t<get_tabs_length(e[p]);t++)sendCS(gettabid(get_tabs(e[p])[t]),{cmd:"closeclickables",force:_,lploggedin:lploggedin},"all")}),clearpopupkbdcounters()}function doPopupResize(e,p,t){sendCS(e,{cmd:"popupfillresize",width:p,height:t},"all")}function do_popupfillinputfocusdecrement(e,p){if(p){var t=1;if(void 0===g_popupform_active[e]&&(g_popupform_active[e]=0),void 0!==p.count){var _=parseInt(p.count);isNaN(_)||(t=_)}g_popupform_active[e]-=t}}function do_popupfillinputfocusincrement(e,p){if(p){var t=1;if(void 0===g_popupform_active[e]&&(g_popupform_active[e]=0),void 0!==p.count){var _=parseInt(p.count);isNaN(_)||(t=_)}g_popupform_active[e]+=t}}function do_popupfillinputfocuschoose(e,p){p&&(g_popupform_active_choose[e]=1)}function do_popupfillinputmoreopen(e,p){p&&(g_popupform_more_open[e]=1)}function do_popupfillinputshownavbar(e,p){p&&(g_popupform_shownavbar[e]=1)}function do_popupkbdnavreset(e){return!!e&&(g_popupform_active[e]=0,g_popupform_active_choose[e]=0,g_popupform_more_open[e]=0,!(g_popupform_shownavbar[e]=0))}function initpopupkbdcounters(e){return!!e&&(void 0===g_popupform_active[e]&&(g_popupform_active[e]=0),void 0===g_popupform_active_choose[e]&&(g_popupform_active_choose[e]=0),void 0===g_popupform_more_open[e]&&(g_popupform_more_open[e]=0),void 0===g_popupform_shownavbar[e]&&(g_popupform_shownavbar[e]=0),!0)}function do_popupfillinputget(e){if(!e||!lploggedin)return{};var p={};return initpopupkbdcounters(e),void 0===g_popupforminput[e]&&(g_popupforminput[e]={value:"",id:"",issaveall:0,inputtype:""}),void 0!==g_popupforminput[e]&&(p={cmd:"gotpopupfillinput",inputstr:g_popupforminput[e].value,inputid:g_popupforminput[e].id,active:g_popupform_active[e],choose:g_popupform_active_choose[e],moreopen:g_popupform_more_open[e],issaveall:g_popupforminput[e].issaveall,inputtype:g_popupforminput[e].inputtype,shownavbar:g_popupform_shownavbar[e]},do_popupkbdnavreset(e)),p}function clearpopupkbdcounters(){return g_popupform_active=[],g_popupform_active_choose=[],g_popupform_more_open=[],g_popupform_shownavbar=[],!0}function do_popupfillsetgenerateprefs(e,p){return!0}function do_popupfillgetgenerateprefs(e,p){if(void 0===e)return{};var t=LPJSON.stringify({generate_advanced:reduxApp.getPreference("generate_advanced"),generate_length:reduxApp.getPreference("generate_length"),generate_upper:reduxApp.getPreference("generate_upper"),generate_lower:reduxApp.getPreference("generate_lower"),generate_digits:reduxApp.getPreference("generate_digits"),generate_special:reduxApp.getPreference("generate_special"),generate_mindigits:reduxApp.getPreference("generate_mindigits"),generate_ambig:reduxApp.getPreference("generate_ambig"),generate_reqevery:reduxApp.getPreference("generate_reqevery"),generate_pronounceable:reduxApp.getPreference("generate_pronounceable")}),_=LPJSON.stringify(g_genpws),o="",r,a;return g_generate_pw_pattern_hints&&(o=(o=g_generate_pw_pattern_hints[e])||""),{prefstr:t,genpwstr:_,genpwpattern:LPJSON.stringify(o)}}